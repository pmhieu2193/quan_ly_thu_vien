<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Thu Tiền Phạt</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .phieu-phat-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .phieu-phat-table td {
            padding: 12px;
            border: 1px solid #ddd;
        }
        .phieu-phat-table td:first-child {
            width: 30%;
            background-color: #f8f9fa;
            font-weight: bold;
        }
        input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        input:disabled {
            background-color: #f8f9fa;
            color: #333;
        }
        .button-container {
            text-align: center;
            margin-top: 20px;
        }
        .btn {
            padding: 10px 20px;
            margin: 0 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-confirm { background-color: #28a745; color: white; }
        .btn-cancel { background-color: #dc3545; color: white; }
    </style>
</head>
<body>
    <h1>Thu Tiền Phạt</h1>
    
    <table class="phieu-phat-table">
        <tr>
            <td>Họ tên độc giả:</td>
            <td><input type="text" id="hoTenDocGia" disabled></td>
        </tr>
        <tr>
            <td>Tổng nợ hiện tại:</td>
            <td><input type="number" id="tongNo" disabled></td>
        </tr>
        <tr>
            <td>Số tiền thu:</td>
            <td><input type="number" id="soTienThu" min="0" onchange="tinhTienConLai()"></td>
        </tr>
        <tr>
            <td>Còn lại:</td>
            <td><input type="number" id="conLai" disabled></td>
        </tr>
    </table>

    <div class="button-container">
        <button class="btn btn-confirm" onclick="xacNhanThu()">Xác nhận</button>
        <button class="btn btn-cancel" onclick="window.location.href='/user.html'">Huỷ</button>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const maDG = urlParams.get('madg');

        // Load thông tin độc giả
        window.onload = async function() {
            try {
                const response = await fetch(`/api/docgia/${maDG}`);
                const docGia = await response.json();
                
                document.getElementById('hoTenDocGia').value = docGia.HoTen;
                document.getElementById('tongNo').value = docGia.TongNo;
                document.getElementById('soTienThu').max = docGia.TongNo;
                document.getElementById('conLai').value = docGia.TongNo;
            } catch (error) {
                console.error('Lỗi:', error);
                alert('Không thể tải thông tin độc giả');
            }
        };

        function tinhTienConLai() {
            const tongNo = parseInt(document.getElementById('tongNo').value) || 0;
            const soTienThu = parseInt(document.getElementById('soTienThu').value) || 0;
            
            if (soTienThu > tongNo) {
                alert('Số tiền thu không được lớn hơn tổng nợ!');
                document.getElementById('soTienThu').value = tongNo;
                document.getElementById('conLai').value = 0;
                return;
            }
            
            document.getElementById('conLai').value = tongNo - soTienThu;
        }

        async function xacNhanThu() {
            const soTienThu = parseInt(document.getElementById('soTienThu').value);
            if (!soTienThu || soTienThu <= 0) {
                alert('Vui lòng nhập số tiền thu hợp lệ!');
                return;
            }

            try {
                const response = await fetch('/api/thu-tien-phat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        maDG: maDG,
                        soTienThu: soTienThu
                    })
                });

                const result = await response.text();
                alert(result);
                window.location.href = '/user.html';
            } catch (error) {
                console.error('Lỗi:', error);
                alert('Có lỗi xảy ra khi xử lý thanh toán');
            }
        }
    </script>
</body>
</html>
